#!/bin/bash

lib=$(dirname $0)/../lib/std.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/lib/$(basename $0).shlib; [ -f ${lib} ] && . ${lib}

function usage()
{
cat <<EOF

Create a set of Amazon EC2 instances.

Usage:

    em create [options] <instance-name> [instance-name ...]

Options:



EOF
exit 0
}

function main()
{
    process-common-arguments $@

    debug "$(basename $0) command line arguments: $@"

    ${help} && usage;

    [ "${args}" = "" ] && fail "specify the instance name"
    [ "${args/ //}" != "${args}" ] && fail "currently we only support creation of an instance at a time"

    local name=${args}

    info "creating instance ${name} ..."

    local new_instance_id

    #
    # create the instance
    #

    new_instance_id=$(ec2-run-instances ami-4dbf9e7d \
        --instance-count 1 \
        --key installation_access \
        --group sg-bb3222de \
        --instance-type t2.micro \
        --availability-zone us-west-2b \
        --tenancy default \
        --block-device-mapping /dev/sda1=:10 \
        --subnet subnet-53993c24 \
        --instance-initiated-shutdown-behavior stop \
        --associate-public-ip-address true | jw ec2.grep_instances --list id) || fail "instance creation failed"

    [ "${new_instance_id}" = "" ] && fail "we could not detect the new instance id"

    #
    # set the Name TAG
    #

    ec2-create-tags ${new_instance_id} --tag Name=${name} || fail "the instance ${new_instance_id} was created but failed to set tag Name=${name}"

    info "instance ${name} created, the instance id is ${new_instance_id}"

}

main $@