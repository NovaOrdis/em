#!/bin/bash

lib=$(dirname $0)/../../lib/std.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/lib/$(basename $0).shlib; [ -f ${lib} ] && . ${lib}

help=false
mode="start"
args=""

function usage()
{
cat <<EOF

$(echo ${mode:0:1} | tr '[:lower:]' '[:upper:]')${mode:1}s the specified instance.

Usage:

    ${mode} <instance-name>

Currently, the instances can be only ${mode}ed one at a time (TODO).

EOF
exit 0
}

function main()
{
    process-common-arguments $@

    debug "$(basename $0) command line arguments: $@"

    local mode=$(basename $0)

    if [ "${mode}" = "start" -o "${mode}" = "stop" ]; then
        debug "mode: ${mode}"
    else
        fail "unknown or unsupported mode: '${mode}'"
    fi

    ${help} && usage;

    [ "${args}" = "" ] && fail "instance name(s) not specified"

    local names=""
    for i in ${args}; do
        [ "${names}" = "" ] && names="${i}" || names="${names}|${i}"
    done

    debug "names: ${names}"

    local ids=$(ec2-describe-instances | jw ec2.ec2_describe_instances_parser --filter name="${names}" --list id) || { exit 1; }

    [ "${ids}" = "" ] && exit 1

    info "${mode}ing ${ids} ..."

    local command="ec2-${mode}-instances ${ids}"

    ${command} || fail "failed to ${mode}"

}

main $@


