#!/bin/bash

lib=$(dirname $0)/../lib/std.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/../lib/em.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/../lib/ec2.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/../lib/linux.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/lib/overlays.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/lib/eap.shlib; [ -f ${lib} ] && . ${lib} || { echo "${lib} not found" 1>&2; exit 1; }
lib=$(dirname $0)/lib/$(basename $0).shlib; [ -f ${lib} ] && . ${lib}

#
# EAP Node overlay
#

#
# dependencies
#

$(dirname $0)/java $@

#
# overlay
#

process-overlay-arguments $@
overlay-preconditions

install-binaries
update-user-environment-for-eap root
update-user-environment-for-eap ec2-user
add-a-management-user admin admin123
configure-public-interface $(get-primary-ip)

# TODO: replace modifying xml with external property (jboss.host.name)
configure-host.xml-host-name $(hostname)

if [ -z "${WE_ARE_EAP_DOMAIN_CONTROLLER}" ]; then

    #
    # we are subordinate host controller
    #
    domain_controller_name=$(extract-domain-controller-name-from-overlay-args ${args}) || exit 1
    domain_controller_ip_address=$(get-internal-ip-for-name ${domain_controller_name}) || exit 1
    configure-master-domain-controller ${domain_controller_ip_address} ${domain_controller_name}

else

    #
    # we are the domain controller
    #

    configure-servers 0
fi

configure-eap-to-start-at-boot

exit 0






